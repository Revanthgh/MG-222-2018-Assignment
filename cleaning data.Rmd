---
title: "MG 222, Advanced Analytics, 2018"
author: "Revanth"
date: "1 April 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.




###################### CLEANING DATA###################


setwd("E:\Data Science\Advanced analytics\assgn2")

# read data set
publicc =  read.csv("E:/Data Science/Advanced analytics/assgn2/publicc.csv")



#Preprocessing of data
##Create AGE variable from DOB
##Age = 0 implies age is unknown
publicc$AGE <- 99-publicc$DOB


#Remove DOB column
publicc$DOB <- NULLVi

##Convert PHON,NKID,DEP to Categorical
publicc$PHON <- as.factor(publicc$PHON)
publicc$NKID <- as.factor(publicc$NKID)
publicc$DEP <- as.factor(publicc$DEP)



==
# Feature selection for continuous variables
# ================================================================================
```
# Feature Selection for Continuous Variables
# We'll apply Fisher's F-test between each cont. variable and "BAD" (the response variable)

sapply(publicc,class)

# select data frame with continuous variables
var.cont = subset(dd, select=c("SINC","DAINC","DHVAL","DMORT","DOUTM","DOUTL","DOUTHP","DOUTCC","AGE"))

# number of continuous variables
ncon = ncol(var.cont)
# number of categorical variables
ncat = ncol(var.cat)


# create empty vector to store results
pval.cont = rep(NA, ncon)

# get the p-values from the F-tests
for (i in 1:ncon) {
  pval.cont[i] = oneway.test(var.cont[,i] ~ publicc$BAD)$p.value
}
# add names to pval.cont
names(pval.cont) = names(var.cont)

# By ordering the continuous variables according to their p-values, we get a ranking of associations with BAD
sort(pval.cont)

#Barplots to visualize
par(mfrow = c(3,4), mar = c(3,3,3,3))
for (i in 1:ncon)
{
  barplot(tapply(var.cont[,i], publicc$BAD, mean), 
          main = paste("Means by", names(pval.cont)[i]), cex.main=0.9,
          border = NA, col = c("steelblue", "skyblue"))
  abline(h = mean(var.cont[,i]), col="gray40")
  legend(0, mean(var.cont[,i]), "global mean", bty="n", text.col="gray20")
}

# The p-values obtained here gives us a rough indication of what variables can be discarded from the analysis
# DAINC           DOUTCC       DOUTHP          AGE         SINC        DOUTM        DHVAL        DMORT        DOUTL 
# 4.564558e-11 2.719794e-06 3.691911e-04 3.952776e-04 1.187606e-02 2.014276e-02 9.531662e-02 1.368168e-01 4.831658e-01 

```


# ================================================================================
# Feature selection for categorical variables
# ================================================================================

# The next step is to do the feature selection for the  # categorical variables. We'll apply chi-square tests
# between each categorized variable and BAD

# select data frame with categorical variables
var.cat = subset(dd, select=c("NKID","DEP","PHON","AES","RES"))

# number of categorical variables
ncat = ncol(var.cat)

# create vector to store results
pval.cat = rep(0, ncat)

# calculate p-values from chi-square tests
for (i in 1:ncat) {
  pval.cat[i] = (chisq.test(var.cat[,i], dd$BAD))$p.value
}

# add names
names(pval.cat) = names(var.cat)

# order categorical variables according to their dependence of BAD
sort(pval.cat)
#    AES          RES         PHON         NKID          DEP 
# 1.569201e-06 2.823040e-03 1.604318e-01 5.032740e-01 5.891899e-01 

```

```
#CODE B
# hypothesis test comparing the mean of the group 
# with the global mean (BAD 0 or 1 categories)

WhoGetsWhatCat <- function(who, what)
{
  # 'who-gets-what' where:
  # who: categorical (AES,RES,etc)
  # what: categorical (BAD)
  
  # table
  what_who <- table(what, who)
  # total number
  n <- sum(what_who)
  # row margin
  pk <- rowSums(what_who) / n
  # column margin
  pj <- colSums(what_who) / n
  # proportional table by rows
  # prop.table(table(who, what), margin=1)
  pf <- what_who / (n*pk)
  
  # z-test comparing proportions
  pjm <- matrix(data=pj, nrow=dim(pf)[1], ncol=dim(pf)[2], byrow=T)      
  dpf <- pf - pjm
  dvt <- sqrt(((1-pk)/(n*pk)) %*%t (pj*(1-pj)))
  zkj <- dpf / dvt
  # zkj follows a normal distribution
  pzkj <- pnorm(zkj, lower.tail=F)
  list(rowpf=pf, vtest=zkj, pval=pzkj)
}

# create list to store results
pvalk.cat = as.list(1:ncat)
for (i in 1:ncat) {  
  pvalk.cat[[i]] = WhoGetsWhatCat(var.cat[,i], publicc$BAD)$pval 
}
names(pvalk.cat) = names(var.cat)
pvalk.cat

# $NKID
# who
# what          0          1          2          3          4          5
# 0     0.85846295 0.36272227 0.29292470 0.59506189 0.05712464 0.14969417
# 1     0.14153705 0.63727773 0.70707530 0.40493811 0.94287536 0.85030583
# 
# $DEP
# who
# what         0         1         2
# 0     0.4343548 0.3894159 0.8396400
# 1     0.5656452 0.6105841 0.1603600
# 
# $PHON
# who
# what          0          1
# 0     0.93492491 0.06507509
# 1     0.06507509 0.93492491
# 
# $AES
# who
# what            B            E            M            N            P            R            T            U
# 0     5.150252e-01 7.612702e-01 4.877110e-01 2.943919e-01 1.987864e-03 9.999997e-01 8.378337e-01 9.359942e-01
# 1     4.849748e-01 2.387298e-01 5.122890e-01 7.056081e-01 9.980121e-01 2.585630e-07 1.621663e-01 6.400580e-02
# who
# what            V            W            Z
# 0     2.532282e-03 9.910019e-01 9.359942e-01
# 1     9.974677e-01 8.998087e-03 6.400580e-02
# 
# $RES
# who
# what            F            N            O            P            U
# 0     1.982365e-01 9.999529e-01 4.724801e-01 1.505717e-01 3.051486e-01
# 1     8.017635e-01 4.706791e-05 5.275199e-01 8.494283e-01 6.948514e-01

for (k in 1:nlevels(dd$BAD)) { 
  print(paste("P-values of BAD Credit:", levels(publicc$BAD)[k]))
  for (j in 1:ncat) {
    print(names(pvalk.cat)[j])
    print(sort(pvalk.cat[[j]][k,]))
    cat("\n")
  }
  cat(rep("=", 50), "\n\n", sep="")
}

# [1] "P-values of BAD Credit: "
# [1] "NKID"
# 4          5          2          1          3          0 
# 0.05712464 0.14969417 0.29292470 0.36272227 0.59506189 0.85846295 
# 
# [1] "DEP"
# 1         0         2 
# 0.3894159 0.4343548 0.8396400 
# 
# [1] "PHON"
# 1          0 
# 0.06507509 0.93492491 
# 
# [1] "AES"
# P           V           N           M           B           E           T           U           Z 
# 0.001987864 0.002532282 0.294391863 0.487711020 0.515025155 0.761270196 0.837833706 0.935994201 0.935994201 
# W           R 
# 0.991001913 0.999999741 
# 
# [1] "RES"
# P         F         U         O         N 
# 0.1505717 0.1982365 0.3051486 0.4724801 0.9999529 
# 


```

library(Information)
library(InformationValue)
library(woe)

IV <- create_infotables(data= publicc,bins = 10, y = "BAD")
IV
# $Summary
# Variable          IV
# 6     DAINC 0.228686369
# 14      AGE 0.197973342
# 5       AES 0.176406850
# 10    DOUTM 0.067657130
# 9     DMORT 0.060520102
# 7       RES 0.059269664
# 8     DHVAL 0.049779687
# 13   DOUTCC 0.031587658
# 11    DOUTL 0.026662236
# 4      SINC 0.019189252
# 1      NKID 0.017447368
# 12   DOUTHP 0.011486183
# 3      PHON 0.009115428
# 2       DEP 0.003923339

# ================================================================================
# Tables for each Predictor Variable containing WoE and IV
# ================================================================================
# NKID   N    Percent         WOE          IV
# 1    0 820 0.66938776  0.04836758 0.001583776
# 2    1 147 0.12000000 -0.06260026 0.002047026
# 3    2 182 0.14857143 -0.08635624 0.003132163
# 4    3  54 0.04408163  0.07145075 0.003360975
# 5    4  19 0.01551020 -1.11310397 0.017447368
# 6    5   3 0.00244898  0.00000000 0.017447368
# 
# DEP    N     Percent          WOE           IV
# 1   0 1185 0.967346939 -0.001970171 3.753081e-06
# 2   1   33 0.026938776 -0.112472086 3.353640e-04
# 3   2    7 0.005714286  0.739280124 3.923339e-03

# PHON    N    Percent         WOE          IV
# 1    0  118 0.09632653  0.28252172 0.008180491
# 2    1 1107 0.90367347 -0.03228902 0.009115428

# SINC   N    Percent          WOE          IV
# 1     [0,2488] 976 0.79673469  0.050355329 0.002044142
# 2  [2500,7800] 122 0.09959184 -0.007111571 0.002049170
# 3 [8000,50000] 127 0.10367347 -0.429712961 0.019189252

# AES   N     Percent         WOE           IV
# 1    B  30 0.024489796  0.01536129 5.799775e-06
# 2    E 124 0.101224490  0.13314432 1.855725e-03
# 3    M  23 0.018775510 -0.01449168 1.859654e-03
# 4    N   6 0.004897959 -0.58247572 3.285125e-03
# 5    P 531 0.433469388 -0.22580077 2.418216e-02
# 6    R 104 0.084897959  0.91144931 1.068754e-01
# 7    T 123 0.100408163  0.18353281 1.104006e-01
# 8    U   8 0.006530612  1.02696220 1.185642e-01
# 9    V 231 0.188571429 -0.41995679 1.484207e-01
# 10   W  37 0.030204082  0.75502848 1.682432e-01
# 11   Z   8 0.006530612  1.02696220 1.764068e-01

# DAINC   N    Percent         WOE        IV
# 1      [0,5703] 244 0.19918367  0.76314761 0.1336882
# 2  [5715,11733] 114 0.09306122  0.17129609 0.1365268
# 3 [12000,16131] 127 0.10367347 -0.06117879 0.1369092
# 4 [16200,19425] 119 0.09714286 -0.34886086 0.1477302
# 5 [19500,23850] 118 0.09632653 -0.28676147 0.1551014
# 6 [24000,28797] 135 0.11020408 -0.06179780 0.1555160
# 7 [28800,34200] 118 0.09632653 -0.14064296 0.1573572
# 8 [34500,43800] 125 0.10204082 -0.51672434 0.1811675
# 9 [44100,64800] 125 0.10204082 -0.75549488 0.2286864

# RES   N    Percent          WOE          IV
# 1   F 129 0.10530612 -0.166960272 0.002817762
# 2   N  66 0.05387755  0.905601340 0.054593319
# 3   O 624 0.50938776 -0.004397865 0.054603161
# 4   P 252 0.20571429 -0.136188613 0.058294117
# 5   U 154 0.12571429 -0.089041835 0.059269664

# DHVAL   N   Percent         WOE           IV
# 1     [0,10176] 734 0.5991837  0.03109507 0.0005835942
# 2 [10464,23392] 123 0.1004082  0.22189710 0.0057786547
# 3 [23744,36464] 117 0.0955102  0.29510050 0.0146505298
# 4 [36928,50176] 127 0.1036735 -0.59195446 0.0457288196
# 5 [50464,64928] 124 0.1012245 -0.20518148 0.0497796866

# DMORT   N    Percent         WOE          IV
# 1         [0,0] 709 0.57877551  0.08585630 0.004351959
# 2      [4,8000] 148 0.12081633  0.23063078 0.011117010
# 3  [8464,27720] 120 0.09795918 -0.77455345 0.058797830
# 4 [28000,46000] 118 0.09632653 -0.09437834 0.059636508
# 5 [46464,64000] 130 0.10612245 -0.09226938 0.060520102

# DOUTM   N    Percent         WOE         IV
# 1    [0,244] 611 0.49877551  0.21603198 0.02443008
# 2  [248,372] 121 0.09877551 -0.17343279 0.02727731
# 3  [376,476] 123 0.10040816 -0.39010382 0.04110754
# 4  [480,636] 124 0.10122449 -0.07165009 0.04161833
# 5  [640,824] 122 0.09959184 -0.54363588 0.06714634
# 6 [840,3800] 124 0.10122449 -0.07165009 0.06765713

# DOUTL   N   Percent         WOE          IV
# 1     [0,156] 977 0.7975510  0.06435349 0.003352789
# 2   [160,384] 124 0.1012245 -0.50696816 0.026151444
# 3 [388,28000] 124 0.1012245 -0.07165009 0.026662236

# DOUTHP    N   Percent         WOE          IV
# 1    [0,32] 1098 0.8963265  0.03483339 0.001096487
# 2 [40,1600]  127 0.1036735 -0.33006178 0.011486183

# DOUTCC    N   Percent         WOE          IV
# 1     [0,96] 1100 0.8979592  0.05528062 0.002779723
# 2 [100,2800]  125 0.1020408 -0.57290626 0.031587658
 
# AGE   N    Percent         WOE         IV
# 1   [0,31]  98 0.08000000  0.57020379 0.02915350
# 2  [32,34] 132 0.10775510 -0.58247572 0.06051386
# 3  [35,36]  97 0.07918367 -0.52185109 0.07933192
# 4  [37,40] 155 0.12653061  0.03724400 0.07950897
# 5  [41,43] 109 0.08897959 -0.29189088 0.08655412
# 6  [44,48] 143 0.11673469 -0.34194042 0.09907000
# 7  [49,53] 120 0.09795918  0.05756164 0.09939896
# 8  [54,60] 122 0.09959184 -0.09362900 0.10025251
# 9  [61,69] 114 0.09306122 -0.14310906 0.10209304
# 10 [70,96] 135 0.11020408  0.86363714 0.19797334

##Note : The Algorithm has automatically binned the continuous Variables - we can use this binning later on for our Model

# - Plot IV

plotFrame <- IV$Summary[order(-IV$Summary$IV), ]
plotFrame$Variable <- factor(plotFrame$Variable,
                             
                             levels = plotFrame$Variable[order(-plotFrame$IV)])

ggplot(plotFrame, aes(x = Variable, y = IV)) +
  geom_bar(width = .35, stat = "identity", color = "darkblue", fill = "white") +
  ggtitle("Information Value") +
  theme_bw() +
  theme(plot.title = element_text(size = 10)) +
  theme(axis.text.x = element_text(angle = 90))

# Plotting WoE
MultiPlot(IV, IV$Summary$Variable[1:14])
